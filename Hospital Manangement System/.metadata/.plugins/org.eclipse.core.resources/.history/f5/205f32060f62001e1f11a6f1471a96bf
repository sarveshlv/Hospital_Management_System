package com.hms.bookingms.service;

import java.util.Date;
import java.util.List;
import java.util.Random;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;

import com.hms.bookingms.clients.IBedServiceClient;
import com.hms.bookingms.clients.IHospitalServiceClient;
import com.hms.bookingms.clients.IPatientServiceClient;
import com.hms.bookingms.dto.AddBookingRequest;
import com.hms.bookingms.dto.Bed;
import com.hms.bookingms.entities.Booking;
import com.hms.bookingms.exceptions.BookingNotFoundException;
import com.hms.bookingms.exceptions.HospitalNotFoundException;
import com.hms.bookingms.exceptions.InvalidBookingRequest;
import com.hms.bookingms.exceptions.InvalidDatesException;
import com.hms.bookingms.exceptions.PatientNotFoundException;
import com.hms.bookingms.repository.BookingRepository;

@Service
public class BookingService implements IBookingService {

	@Autowired
	private IBedServiceClient bedServiceClient;

	@Autowired
	private IPatientServiceClient patientServiceClient;

	@Autowired
	private IHospitalServiceClient hospitalServiceClient;

	@Autowired
	private BookingRepository bookingRepository;

	@Override
	public Booking addBooking(String authorizationHeader, AddBookingRequest addBookingRequest)
			throws PatientNotFoundException, HospitalNotFoundException, InvalidDatesException {
		String patientId = addBookingRequest.getPatientId();
		String hospitalId = addBookingRequest.getHospitalId();

		Date bookingDate = new Date();
		Date occupyDate = addBookingRequest.getOccupyDate();
		Date releaseDate = addBookingRequest.getReleaseDate();

		if (patientServiceClient.isPatientFound(authorizationHeader, patientId).getStatusCode() != HttpStatus.OK) {
			throw new PatientNotFoundException(patientId);
		} else if (hospitalServiceClient.isHospitalFound(authorizationHeader, hospitalId).getStatusCode() != HttpStatus.OK) {
			throw new HospitalNotFoundException(hospitalId);
		} else if (occupyDate.before(bookingDate) || releaseDate.before(occupyDate)) {
			throw new InvalidDatesException(bookingDate, occupyDate, releaseDate);
		}

		Booking booking = new Booking();

		booking.setPatientId(patientId);
		booking.setHospitalId(hospitalId);
		booking.setBedType(Booking.BedType.valueOf(addBookingRequest.getBedType()));
		booking.setBookingStatus(Booking.BookingStatus.REQUESTED);
		booking.setBookingDate(new Date());
		booking.setOccupyDate(occupyDate);
		booking.setReleaseDate(releaseDate);

		return bookingRepository.save(booking);
	}

	@Override
	public Booking findBookingById(String bookingId) throws BookingNotFoundException {
		return bookingRepository.findById(bookingId).orElseThrow(() -> new BookingNotFoundException(bookingId));
	}

	@Override
	public List<Booking> getBookingByPatientId(String patientId) throws PatientNotFoundException {
		return bookingRepository.findAllByPatientId(patientId);
	}

	@Override
	public Booking approveBooking(String authorizationHeader, String bookingId)
			throws BookingNotFoundException, InvalidBookingRequest, RuntimeException {
		Booking booking = findBookingById(bookingId);
		if (booking.getBookingStatus().equals(Booking.BookingStatus.REQUESTED)) {

			List<Bed> beds = bedServiceClient.findBedsByHospitalId(authorizationHeader, booking.getHospitalId());
			beds = beds.stream().filter(bed -> bed.getBedType().equals(booking.getBedType().toString())).collect(Collectors.toList());
			if (beds.isEmpty()) {
				throw new RuntimeException("No beds found for bed type: " + booking.getBedType());
			}
			int randomIndex = new Random().nextInt(beds.size());
			Bed randomBed = beds.get(randomIndex);
			String bedId = randomBed.getId();
			
			bedServiceClient.bookBed(authorizationHeader, randomBed.getId());

			booking.setBookingStatus(Booking.BookingStatus.APPROVED);
			booking.setBedId(bedId);
			return bookingRepository.save(booking);
		}
		throw new InvalidBookingRequest(booking.getBookingStatus().toString());

	}

	@Override
	public Booking rejectBooking(String bookingId) throws BookingNotFoundException, InvalidBookingRequest {
		Booking booking = findBookingById(bookingId);
		if (booking.getBookingStatus().equals(Booking.BookingStatus.REQUESTED)) {
			booking.setBookingStatus(Booking.BookingStatus.DECLINED);
			return bookingRepository.save(booking);
		}
		throw new InvalidBookingRequest(booking.getBookingStatus().toString());
	}
import com.hms.bookingms.clients.IBedServiceClient;
import com.hms.bookingms.clients.IHospitalServiceClient;
import com.hms.bookingms.clients.IPatientServiceClient;
import com.hms.bookingms.dto.AddBookingRequest;
import com.hms.bookingms.entities.Booking;
import com.hms.bookingms.exceptions.*;
import com.hms.bookingms.repository.BookingRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

public class BookingServiceTest {

	@Mock
	private IBedServiceClient bedServiceClient;

	@Mock
	private IPatientServiceClient patientServiceClient;

	@Mock
	private IHospitalServiceClient hospitalServiceClient;

	@Mock
	private BookingRepository bookingRepository;

	@InjectMocks
	private BookingService bookingService;

	@BeforeEach
	void setUp() {
		MockitoAnnotations.openMocks(this);
	}

	@Test
	void testAddBooking_ValidRequest()
			throws PatientNotFoundException, HospitalNotFoundException, InvalidDatesException {
		// Arrange
		AddBookingRequest addBookingRequest = createValidAddBookingRequest();
		Booking savedBooking = createSampleBooking();

		when(patientServiceClient.isPatientFound(anyString(), anyString())).thenReturn(ResponseEntity.ok().build());
		when(hospitalServiceClient.isHospitalFound(anyString(), anyString())).thenReturn(ResponseEntity.ok().build());
		when(bookingRepository.save(any(Booking.class))).thenReturn(savedBooking);

		// Act
		Booking result = bookingService.addBooking("AuthorizationHeader", addBookingRequest);

		// Assert
		assertNotNull(result);
		assertEquals(savedBooking, result);
		assertEquals(Booking.BookingStatus.REQUESTED, result.getBookingStatus());
	}

	@Test
	void testAddBooking_PatientNotFound() throws PatientNotFoundException {
		// Arrange
		AddBookingRequest addBookingRequest = createValidAddBookingRequest();

		when(patientServiceClient.isPatientFound(anyString(), anyString()))
				.thenReturn(ResponseEntity.notFound().build());

		// Act and Assert
		assertThrows(PatientNotFoundException.class,
				() -> bookingService.addBooking("AuthorizationHeader", addBookingRequest));
	}

	@Test
	void testAddBooking_HospitalNotFound() throws PatientNotFoundException, HospitalNotFoundException {
		// Arrange
		AddBookingRequest addBookingRequest = createValidAddBookingRequest();

		when(patientServiceClient.isPatientFound(anyString(), anyString())).thenReturn(ResponseEntity.ok().build());
		when(hospitalServiceClient.isHospitalFound(anyString(), anyString()))
				.thenReturn(ResponseEntity.notFound().build());

		// Act and Assert
		assertThrows(HospitalNotFoundException.class,
				() -> bookingService.addBooking("AuthorizationHeader", addBookingRequest));
	}

	@Test
	void testAddBooking_InvalidDates() throws PatientNotFoundException, HospitalNotFoundException {
		// Arrange
		AddBookingRequest addBookingRequest = createInvalidDateAddBookingRequest();

		when(patientServiceClient.isPatientFound(anyString(), anyString())).thenReturn(ResponseEntity.ok().build());
		when(hospitalServiceClient.isHospitalFound(anyString(), anyString())).thenReturn(ResponseEntity.ok().build());

		// Act and Assert
		assertThrows(InvalidDatesException.class,
				() -> bookingService.addBooking("AuthorizationHeader", addBookingRequest));
	}

	@Test
	void testFindBookingById_BookingFound() throws BookingNotFoundException {
		// Arrange
		Booking sampleBooking = createSampleBooking();
		when(bookingRepository.findById(anyString())).thenReturn(java.util.Optional.of(sampleBooking));

		// Act
		Booking result = bookingService.findBookingById("bookingId");

		// Assert
		assertNotNull(result);
		assertEquals(sampleBooking, result);
	}

	@Test
	    void testFindBookingById_BookingNotFound() {
	        // Arrange
	        when(bookingRepository.findById(anyString())).thenReturn(Optional.empty());

	        // Act and Assert
	        assertThrows(BookingNotFoundException.class, () -> bookingService.findBookingById("nonexistentBookingId"));
	    }

	@Test
	void testGetBookingByPatientId_PatientFound() throws PatientNotFoundException {
		// Arrange
		List<Booking> sampleBookings = createSampleBookingList();
		when(bookingRepository.findAllByPatientId(anyString())).thenReturn(sampleBookings);

		// Act
		List<Booking> result = bookingService.getBookingByPatientId("patientId");

		// Assert
		assertNotNull(result);
		assertEquals(sampleBookings, result);
	}

	@Test
	    void testGetBookingByPatientId_PatientNotFound() {
	        // Arrange
	        when(bookingRepository.findAllByPatientId(anyString())).thenReturn(new ArrayList<>());

	        // Act and Assert
	        assertThrows(PatientNotFoundException.class, () -> bookingService.getBookingByPatientId("nonexistentPatientId"));
	    }

	@Test
	void testApproveBooking_BookingRequested() throws BookingNotFoundException, InvalidBookingRequest {
		// Arrange
		Booking sampleBooking = createSampleBooking();
		Bed sampleBed = createSampleBed();

		when(bookingRepository.findById(anyString())).thenReturn(java.util.Optional.of(sampleBooking));
		when(bedServiceClient.findBedsByHospitalId(anyString(), anyString())).thenReturn(List.of(sampleBed));
		when(bedServiceClient.bookBed(anyString(), anyString())).thenReturn(true);

		// Act
		Booking result = bookingService.approveBooking("AuthorizationHeader", "bookingId");

		// Assert
		assertNotNull(result);
		assertEquals(Booking.BookingStatus.APPROVED, result.getBookingStatus());
		assertNotNull(result.getBedId());
	}

	@Test
	void testApproveBooking_BookingNotRequested() {
		// Arrange
		Booking sampleBooking = createSampleBooking();
		sampleBooking.setBookingStatus(Booking.BookingStatus.APPROVED);

		when(bookingRepository.findById(anyString())).thenReturn(java.util.Optional.of(sampleBooking));

		// Act and Assert
		assertThrows(InvalidBookingRequest.class,
				() -> bookingService.approveBooking("AuthorizationHeader", "bookingId"));
	}

	@Test
	void testRejectBooking_BookingRequested() throws BookingNotFoundException, InvalidBookingRequest {
		// Arrange
		Booking sampleBooking = createSampleBooking();

		when(bookingRepository.findById(anyString())).thenReturn(java.util.Optional.of(sampleBooking));

		// Act
		Booking result = bookingService.rejectBooking("bookingId");

		// Assert
		assertNotNull(result);
		assertEquals(Booking.BookingStatus.DECLINED, result.getBookingStatus());
	}

	@Test
	void testRejectBooking_BookingNotRequested() {
		// Arrange
		Booking sampleBooking = createSampleBooking();
		sampleBooking.setBookingStatus(Booking.BookingStatus.APPROVED);

		when(bookingRepository.findById(anyString())).thenReturn(java.util.Optional.of(sampleBooking));

		// Act and Assert
		assertThrows(InvalidBookingRequest.class, () -> bookingService.rejectBooking("bookingId"));
	}

	@Test
	void testCancelBooking_BookingRequested() throws BookingNotFoundException, InvalidBookingRequest {
		// Arrange
		Booking sampleBooking = createSampleBooking();

		when(bookingRepository.findById(anyString())).thenReturn(java.util.Optional.of(sampleBooking));

		// Act
		Booking result = bookingService.cancelBooking("AuthorizationHeader", "bookingId");

		// Assert
		assertNotNull(result);
		assertEquals(Booking.BookingStatus.CANCELLED, result.getBookingStatus());
	}

	@Test
	void testCancelBooking_BookingNotRequested() {
		// Arrange
		Booking sampleBooking = createSampleBooking();
		sampleBooking.setBookingStatus(Booking.BookingStatus.APPROVED);

		when(bookingRepository.findById(anyString())).thenReturn(java.util.Optional.of(sampleBooking));

		// Act and Assert
		assertThrows(InvalidBookingRequest.class,
				() -> bookingService.cancelBooking("AuthorizationHeader", "bookingId"));
	}

	@Test
	void testCompleteBooking_BookingApproved() {
		// Arrange
		Booking sampleBooking = createSampleBooking();
		sampleBooking.setBookingStatus(Booking.BookingStatus.APPROVED);
		Bed sampleBed = createSampleBed();

		when(bookingRepository.findById(anyString())).thenReturn(java.util.Optional.of(sampleBooking));
		when(bedServiceClient.completeBooking(anyString(), anyString())).thenReturn(true);

		// Act
		Booking result = bookingService.completeBooking("AuthorizationHeader", "bookingId");

		// Assert
		assertNotNull(result);
		assertEquals(Booking.BookingStatus.COMPLETED, result.getBookingStatus());
	}

	@Test
	void testCompleteBooking_BookingNotApproved() {
		// Arrange
		Booking sampleBooking = createSampleBooking();
		sampleBooking.setBookingStatus(Booking.BookingStatus.REQUESTED);

		when(bookingRepository.findById(anyString())).thenReturn(java.util.Optional.of(sampleBooking));

		// Act and Assert
		assertThrows(InvalidBookingRequest.class,
				() -> bookingService.completeBooking("AuthorizationHeader", "bookingId"));
	}

	private AddBookingRequest createValidAddBookingRequest() {
		AddBookingRequest request = new AddBookingRequest();
		request.setPatientId("patientId");
		request.setHospitalId("hospitalId");
		request.setBedType("USUAL_BED");
		request.setOccupyDate(new Date(System.currentTimeMillis() + 24 * 60 * 60 * 1000));
		request.setReleaseDate(new Date(System.currentTimeMillis() + 48 * 60 * 60 * 1000));
		return request;
	}

	private AddBookingRequest createInvalidDateAddBookingRequest() {
		AddBookingRequest request = new AddBookingRequest();
		request.setPatientId("patientId");
		request.setHospitalId("hospitalId");
		request.setBedType("USUAL_BED");
		request.setOccupyDate(new Date(System.currentTimeMillis() - 24 * 60 * 60 * 1000));
		request.setReleaseDate(new Date(System.currentTimeMillis() + 24 * 60 * 60 * 1000));
		return request;
	}

	private Booking createSampleBooking() {
		Booking booking = new Booking();
		booking.setId("bookingId");
		booking.setPatientId("patientId");
		booking.setHospitalId("hospitalId");
		booking.setBedType(Booking.BedType.USUAL_BED);
		booking.setBookingDate(new Date());
		booking.setOccupyDate(new Date(System.currentTimeMillis() + 24 * 60 * 60 * 1000));
		booking.setReleaseDate(new Date(System.currentTimeMillis() + 48 * 60 * 60 * 1000));
		booking.setBookingStatus(Booking.BookingStatus.REQUESTED);
		return booking;
	}

	private List<Booking> createSampleBookingList() {
		List<Booking> bookings = new ArrayList<>();
		bookings.add(createSampleBooking());
		return bookings;
	}

	private Bed createSampleBed() {
		Bed bed = new Bed();
		bed.setId("bedId");
		bed.setBedType("USUAL_BED");
		return bed;
	}
}
